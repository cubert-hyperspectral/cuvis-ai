name: drcnn_adaclip
pipeline:
  name: ''
  nodes:
  - name: LentilsAnomalyDataNode
    class: cuvis_ai.node.data.LentilsAnomalyDataNode
    params:
      normal_class_ids:
      - 0
      - 1
  - name: MinMaxNormalizer
    class: cuvis_ai.node.normalization.MinMaxNormalizer
    params:
      eps: 1.0e-06
      use_running_stats: true
  - name: channel_mixer
    class: cuvis_ai.node.channel_mixer.LearnableChannelMixer
    params:
      input_channels: 61
      output_channels: 3
      leaky_relu_negative_slope: 0.1
      use_bias: true
      use_activation: true
      normalize_output: true
      init_method: pca
      eps: 1.0e-06
      reduction_scheme:
      - 61
      - 16
      - 8
      - 3
  - name: adaclip
    class: cuvis_ai_adaclip.node.adaclip_node.AdaCLIPDetector
    params:
      weight_name: pretrained_all
      backbone: ViT-L-14-336
      prompt_text: 'normal: lentils, anomaly: stones'
      image_size: 518
      prompting_depth: 4
      prompting_length: 5
      gaussian_sigma: 4.0
      use_half_precision: false
      enable_warmup: false
      enable_gradients: true
  - name: iou_loss
    class: cuvis_ai.node.losses.IoULoss
    params:
      weight: 1.0
      smooth: 1.0e-06
      normalize_method: minmax
  - name: decider
    class: cuvis_ai.deciders.binary_decider.QuantileBinaryDecider
    params:
      quantile: 0.995
      reduce_dims: null
  - name: metrics_anomaly
    class: cuvis_ai.node.metrics.AnomalyDetectionMetrics
    params:
      execution_stages: null
  - name: score_heatmap
    class: cuvis_ai.node.visualizations.ScoreHeatmapVisualizer
    params:
      normalize_scores: true
      cmap: inferno
      up_to: 5
  - name: mask
    class: cuvis_ai.node.visualizations.AnomalyMask
    params:
      channel: 30
      up_to: 5
  - name: drcnn_tensorboard_viz
    class: cuvis_ai.node.drcnn_tensorboard_viz.DRCNNTensorBoardViz
    params:
      hsi_channels:
      - 0
      - 20
      - 40
      max_samples: 4
      log_every_n_batches: 1
  - name: TensorBoardMonitorNode
    class: cuvis_ai.node.monitor.TensorBoardMonitorNode
    params:
      output_dir: outputs\drcnn_adaclip\tensorboard
      run_name: DRCNN_AdaClip_Gradient
      comment: ''
      flush_secs: 120
  connections:
  - from: LentilsAnomalyDataNode.outputs.cube
    to: MinMaxNormalizer.inputs.data
  - from: LentilsAnomalyDataNode.outputs.mask
    to: iou_loss.inputs.targets
  - from: LentilsAnomalyDataNode.outputs.mask
    to: metrics_anomaly.inputs.targets
  - from: LentilsAnomalyDataNode.outputs.mask
    to: mask.inputs.mask
  - from: LentilsAnomalyDataNode.outputs.cube
    to: mask.inputs.cube
  - from: LentilsAnomalyDataNode.outputs.cube
    to: drcnn_tensorboard_viz.inputs.hsi_cube
  - from: LentilsAnomalyDataNode.outputs.mask
    to: drcnn_tensorboard_viz.inputs.ground_truth_mask
  - from: MinMaxNormalizer.outputs.normalized
    to: channel_mixer.inputs.data
  - from: channel_mixer.outputs.rgb
    to: adaclip.inputs.rgb_image
  - from: channel_mixer.outputs.rgb
    to: drcnn_tensorboard_viz.inputs.mixer_output
  - from: adaclip.outputs.scores
    to: iou_loss.inputs.predictions
  - from: adaclip.outputs.scores
    to: decider.inputs.logits
  - from: adaclip.outputs.scores
    to: metrics_anomaly.inputs.logits
  - from: adaclip.outputs.scores
    to: score_heatmap.inputs.scores
  - from: adaclip.outputs.scores
    to: mask.inputs.scores
  - from: adaclip.outputs.scores
    to: drcnn_tensorboard_viz.inputs.adaclip_scores
  - from: decider.outputs.decisions
    to: metrics_anomaly.inputs.decisions
  - from: decider.outputs.decisions
    to: mask.inputs.decisions
  - from: metrics_anomaly.outputs.metrics
    to: TensorBoardMonitorNode.inputs.metrics
  - from: score_heatmap.outputs.artifacts
    to: TensorBoardMonitorNode.inputs.artifacts
  - from: mask.outputs.artifacts
    to: TensorBoardMonitorNode.inputs.artifacts
  - from: drcnn_tensorboard_viz.outputs.artifacts
    to: TensorBoardMonitorNode.inputs.artifacts
  metadata:
    name: DRCNN_AdaClip_Gradient
    description: ''
    created: '2026-01-05T11:33:21.691178'
    tags: []
    author: ''
    cuvis_ai_version: 0.1.5.post40+g5d4ea80af.d20260105
data:
  cu3s_file_path: data/Lentils/Lentils_000.cu3s
  annotation_json_path: data/Lentils/Lentils_000.json
  train_ids:
  - 0
  - 2
  - 3
  val_ids:
  - 1
  test_ids:
  - 1
  - 5
  train_split: null
  val_split: null
  shuffle: true
  batch_size: 2
  processing_mode: Reflectance
training:
  seed: 42
  optimizer:
    name: adamw
    lr: 0.001
    weight_decay: 0.01
    momentum: 0.9
    betas:
    - 0.9
    - 0.999
  scheduler:
    name: reduce_on_plateau
    warmup_epochs: 0
    min_lr: 1.0e-06
    t_max: null
    step_size: null
    gamma: null
    monitor: metrics_anomaly/iou
    mode: max
    factor: 0.5
    patience: 5
    threshold: 0.0001
    threshold_mode: rel
    cooldown: 0
    eps: 1.0e-08
    verbose: false
  callbacks: null
  trainer:
    max_epochs: 20
    accelerator: auto
    devices: 1
    default_root_dir: ./outputs/drcnn_adaclip
    precision: 32-true
    accumulate_grad_batches: 1
    enable_progress_bar: true
    enable_checkpointing: true
    log_every_n_steps: 10
    val_check_interval: 1.0
    check_val_every_n_epoch: 1
    gradient_clip_val: 1.0
    deterministic: false
    benchmark: false
    callbacks:
      checkpoint:
        dirpath: outputs\drcnn_adaclip\checkpoints
        filename: '{epoch:02d}'
        monitor: metrics_anomaly/iou
        mode: max
        save_top_k: 3
        every_n_epochs: 1
        save_last: true
        auto_insert_metric_name: true
        verbose: true
        save_on_exception: false
        save_weights_only: false
        every_n_train_steps: null
        train_time_interval: null
        save_on_train_epoch_end: null
        enable_version_counter: true
      early_stopping: []
      learning_rate_monitor:
        logging_interval: epoch
        log_momentum: false
        log_weight_decay: false
  max_epochs: 20
  batch_size: 32
  num_workers: 4
  gradient_clip_val: 1.0
  accumulate_grad_batches: 1
loss_nodes:
- iou_loss
metric_nodes:
- metrics_anomaly
freeze_nodes: []
unfreeze_nodes:
- channel_mixer
output_dir: outputs\drcnn_adaclip
tags: {}
